# Песочница T-Invest API

## Работа с песочницей

Песочница — это тестовый контур. Работа в песочнице не влияет на реальные данные.

С ней можно работать несколькими способами:

1. Вызывать методы по адресу песочницы — `sandbox-invest-public-api.tbank.ru:443`.
2. Пользоваться только методами песочницы.

Мы рекомендуем использовать первый способ.

[Подробнее про различия контуров](/invest/intro/developer/sandbox/url_difference)

## Методы

### Работа со счетами

Для тестирования своего торгового робота в песочнице можно использовать неограниченное
количество счетов, которые есть только в песочнице и не связаны реальными
торгами на бирже.

- [OpenSandboxAccount](/invest/intro/developer/sandbox/methods#opensandboxaccount) — создать специальный счет песочницы;
- [SandboxPayIn](/invest/intro/developer/sandbox/methods#sandboxpayin) — пополнить баланс счета песочницы;
- [CloseSandboxAccount](/invest/intro/developer/sandbox/methods#closesandboxaccount) — закрыть счет в песочнице.

:::info
Пополнять счет песочницы можно не только в рублях. Существуют лимиты на максимальную сумму пополнения. Они соответствуют лимитам на [максимальную стоимость заявки](/invest/services/orders/faq_orders).
:::

Чтобы получить список своих счетов в песочнице, используйте метод [getAccount](/invest/intro/developer/sandbox/methods##getaccounts).

:::caution

<p>Все счета в песочнице виртуальные и могут быть удалены в любое
время. Если созданный ранее счет не найден, создайте новый. 
Счета хранятся 3 месяца с даты последнего использования.</p>
<p>В песочнице нет стоп-заявок и маржинальных показателей. Также не рассчитываются дополнительные показатели счета, 
ставки риска, размер гарантийного обеспечения и ликвидность портфеля.</p>
:::

### Состояние портфеля

Методы для получения операций и портфеля аналогичны методам основных сервисов:

- [getSandboxOperations](/invest/intro/developer/sandbox/methods#getsandboxoperations) — получить операции по счету;
- [getSandboxPortfolio](/invest/intro/developer/sandbox/methods#getsandboxportfolio) — получить портфолио по счету;
- [getSandboxPositions](/invest/intro/developer/sandbox/methods#getsandboxpositions) — получить список позиций по счету.

:::caution
Для методов песочницы не рассчитываются некоторые статистические параметры портфеля — например, относительная и 
абсолютная доходности.
:::

### Торговые поручения

Параметры методов выставления, отмены и получения статуса торгового поручения в
песочнице аналогичны основным методам T-Invest API.

- [postSandboxOrder](/invest/intro/developer/sandbox/methods#postsandboxorder) — выставить торговое поручение;
- [getSandboxOrderState](/invest/intro/developer/sandbox/methods#getsandboxorderstate) — получить статус торгового поручения;
- [cancelSandboxOrder](/invest/intro/developer/sandbox/methods#cancelsandboxorder) — отменить выставленное торговое поручение;
- [getSandboxOrders](/invest/intro/developer/sandbox/methods#getsandboxorders) — получить список торговых поручений по счету.

### Сервис операций

<ul>
<li><p><a href="/invest/intro/developer/sandbox/methods#getsandboxoperations">GetSandboxOperations</a> и <a href="/invest/intro/developer/sandbox/methods#getsandboxoperationsbycursor">GetSandboxOperationsByCursor</a> — получить операции по номеру счета. В <code>OperationType</code> поддерживают фильтрацию только по типам <code>OPERATION_TYPE_BUY</code> и <code>OPERATION_TYPE_SELL</code>.</p>
</li>
<li><p><a href="/invest/intro/developer/sandbox/methods#getdividendsforeignissuer">GetDividendsForeignIssuer</a> — получить отчет «Справка о доходах за пределами РФ».</p>
<p> Обратите внимание: в этом методе песочницы всегда возвращается пустой ответ.</p>
<pre><code> 
     {`
     {"div_foreign_issuer_report": {     
        "dividends_foreign_issuer_report": [],
        "itemsCount": 0,     
        "pagesCount": 0,     
        "page": 0   
      }},
      {"payload": "div_foreign_issuer_report"}
     `}
</code></pre></li>
<li><p><a href="/invest/intro/developer/sandbox/methods#getbrokerreport">GetBrokerReport</a> — получить брокерский отчет.</p>
<p> Обратите внимание: в этом методе песочницы всегда возвращается пустой ответ.</p>
<pre><code> 
     {`
      {"get_broker_report_response": {
        "broker_report": [],
        "itemsCount": 0,     
        "pagesCount": 0,     
        "page": 0
      }},
      {"payload": "get_broker_report_response"}
    `}
</code></pre></li>
<li><p><a href="/invest/intro/developer/sandbox/methods#portfoliostream">PortfolioStream</a> — server-side стрим обновлений портфеля.</p>
</li>
<li><p><a href="/invest/intro/developer/sandbox/methods#positionsstream">PositionsStream</a> — server-side стрим обновления информации по изменению позиций портфеля.</p>
</li>
<li><p><a href="/invest/intro/developer/sandbox/methods#getportfolio">GetPortfolio</a> — получить портфель по счету.</p>
</li>
</ul>

### Сервис ордеров

[TradesStream](/invest/intro/developer/sandbox/methods#tradesstream) — получить портфель по счету.

### Сервис cчетов

[GetMarginAttributes](/invest/intro/developer/sandbox/methods#getmarginattributes) — получить портфель по счету.

Обратите внимание — в этом методе песочницы возвращаются следующие значения:

- `liquid_portfolio (ликвидной стоимости портфеля) = стоимость портфеля`.
- `starting_margin  = corrected_margin = minimal_margin = amount_of_missing_funds = 0`.
- `funds_sufficiency_level = 2`.

<a name="orderexecute"></a>

## Особенности торговли

Тестирование в песочнице приближено к реальному, но имеет ряд особенностей. Наиболее важные из них:

- Для всех клиентов открыты все инструменты — в том числе те, которые предназначены для квалифицированных инвесторов. 
Проходить тестирование или получать статус квалифицированного инвестора не нужно.

- Открыта маржинальная торговля и короткие позиции. При этом ликвидность портфеля рассчитывается упрощенным способом —
для всех участников по всем инструментам «плечо» в обе стороны (покупка или продажа) равно 2.
   
   Пример.
   При первоначальном балансе 1000 рублей можно купить или продать активы на 2000 рублей. 
   Торговля с плечом (маржинальная торговля) не увеличивает первоначальный баланс — это можно использовать для улучшения 
   доходности стратегии.

- При торговле фьючерсами в случае покупки со счета списывается полная стоимость, а не гарантийное обеспечение (ГО), 
как при торговле на Московской бирже. При продаже начисляется полная стоимость. 

   Вариационная маржа не рассчитывается.

- Нет начислений по выплатам купонов или дивидендов.
- Налоги не рассчитываются.
- Комиссия рассчитывается в размере 0.05 % от объема сделки вне зависимости от инструмента.

## Алгоритм исполнения торговых поручений

Алгоритм исполнения торговых поручений в песочнице отличается от «боевого» алгоритма.

<ul>
<li>Рыночные (market) ордеры исполняются по цене последней сделки (last price).</li>
<li><p>Выставленные заявки не влияют на рынок. </p>
<p>Пример.
Рыночные заявки на 1 лот и на 10 000 лотов будут исполнены по одинаковой цене,
даже если в «стакане» по этой цене не было достаточного количество встречных предложений.</p>
</li>
<li><p>При выставлении лимитного ордера проверяется цена в «стакане» — если есть встречное предложение хотя бы на 1 лот из всего объема, ордер полностью будет исполнен по цене лучшего встречного предложения.</p>
</li>
<li>Если лимитный ордер не может исполниться в момент выставления, он встает в рынок и ожидает появления предложений. При этом ордер не участвует в формировании «стакана».</li>
<li><p>При выставлении торгового поручения при продаже со счета песочницы блокируются активы, а при покупке — денежные средства. </p>

:::caution
Операции появляются только при исполнении торгового поручения.
:::

</li>
<li><p>Сервис получает информацию от торговых площадок о последних сделках по всем инструментам и исполняет активные заявки. </p>
<p>Пример.
Есть заявка на покупку акции по цене 100 рублей. Если цена инструмента в последней сделке с биржи равна 100 рублей или 
меньше, заявка исполняется по цене, которая была в ней указана — то есть по 100 рублей.
Заявка на продажу исполняется, когда цена последней сделки будет 100 рублей или больше.</p>
</li>
<li><p>Все неисполненные торговые поручения в песочнице отменяются после окончания торговой сессии. 
Заблокированные активы возвращаются на счет.</p>
</li>
</ul>
