---
sidebar_position: 1
---

import Accordion from '@platform-ui/accordion';
import { DocImage } from "@/components/DocImage";

# Описание

Сервис для работы с торговыми поручениями.

<Accordion
  data={[
    {
      content: (
      <div>
<DocImage width={700} src="/img/invest/order_status_diagram.png" width="650"/>
      </div> ),
      title: 'Статусная модель заявок',
    }
  ]}
  onTitleClick={function noRefCheck(){}}
  size="m"
  scrollToActive={false}
/>

## Выставить заявку

Одна из главных функций торгового робота — выставление заявок на бирже. 

Для этого можно использовать unary-метод [postOrder](/invest/services/orders/methods#postorder).
Через него можно выставлять все типы заявок — и рыночные, и лимитные. 

В запросе метода передается параметр **instrument_id** — идентификатор инструмента, который принимает значения `figi` или `instrument_uid`. [Подробнее об идентификаторах](/invest/intro/intro/faq_identification/).

[Подробнее о торговых поручениях, их видах и особенностях исполнения на биржах](/invest/services/orders/faq_orders/)

:::caution
Чтобы исключить дублирование заявок, используется параметр <b>order_id</b> — его нужно сгенерировать любым удобным
способом перед вызовом метода. Если сервис получит несколько запросов с одинаковым <b>order_id</b>, на биржу
выставится только одно торговое поручение. Все последующие запросы с одним <b>order_id</b> будут возвращать
ошибку выставления — `30057`.
:::

:::info
Сейчас у нас есть два параметра с одинаковым названием:<br />
<ul>
<li><b>order_id</b> как входной параметр — ключ идемпотентности. Уникальность значений отслеживается только за последний месяц.</li>
<li><b>order_id</b> как выходной параметр — биржевой идентификатор заявки, который в дальнейшем используется для отслеживания статуса заявки. </li>
</ul>
:::


При выполнении операций с облигациями также учитывайте [накопленный купонный доход](/invest/intro/intro/glossary).
Размер НКД можно узнать через методы получения информации по облигациям или метод выставления торгового поручения — для этого используется параметр **aci_value**. 

Обратите внимание: в параметре **aci_value** возвращается размер НКД в валюте расчетов за 1 лот. То есть при покупке облигаций к стоимости сделки будет добавлено произведение НКД на количество лотов в сделке (`aci_value`∗`quantity`), при продаже — сумма сделки будет уменьшена на это произведение.

Выставлять заявку с отрицательным значением цены можно только для фьючерсов — в остальных случаях метод вернет ошибку.

:::info
Сейчас выставить заявку стоимостью больше 30 млн рублей через T-Invest API нельзя — ее нужно подтверждать по СМС.
Поэтому мы рекомендуем разбивать такие заявки на заявки меньшего размера.
:::

## Получить список активных заявок по счету

Чтобы торговый робот более эффективно управлял торговыми поручениями, ему нужно иметь 
возможность получать список активных заявок на данный момент. 

Для этого можно использовать метод [getOrders](/invest/services/orders/methods#getorders). Обратите внимание: метод 
возвращает только активные торговые поручения — после исполнения заявка пропадает из возвращаемого списка. 

## Получить статус торгового поручения

Статус исполнения поданного торгового поручения можно
 используя метод [getOrderState](/invest/services/orders/methods#getorderstate). Помимо статуса он возвращает стадии выполнения заявки — массив **stages**.

:::caution
Метод не предусмотрен для получения глубокой истории и может не возвращать информацию по поручениям, которым больше одного дня.
:::

## Идентификатор ключа идемпотентности

**Пример**. Вы оформляете заявку на покупку ценной бумаги. Запрос может потеряться в пути, и вы пробуете отправить его еще раз. Проблема в том, что мог потеряться не запрос, а ответ — и тогда будут созданы две заявки.

Поэтому для таких операций есть требование идемпотентности — это значит, что при повторном вызове операции результат будет тот же, что и при первом. В нашем примере — вне зависимости от того, сколько раз был отправлен запрос, должна быть создана только одна заявка или ни одной, если возникнет ошибка.

Стандартный способ достичь идемпотентности — генерация ключа идемпотентности на стороне клиента. Это некое уникальное значение: на стороне обработки запроса выполняется только та операция, ключ которой еще не встречался. Таким образом можно делать повторные вызовы безопасно.

:::caution
Для сохранения единообразия параметр <b>order_id</b> означает:<br />
<ul>
<li>В запросах метода <a href="/invest/services/orders/methods#postorder">postOrder</a> — ключ идемпотентности, передаваемый от клиента. </li>
<li>В ответах метода <a href="/invest/services/orders/methods#postorder">postOrder</a> — биржевой идентификатор заявки. </li>
</ul>
<p>В ответах других методов ключ идемпотентности, который передается клиентом, — это параметр <b>order_request_id</b>. </p>
:::

В запросе метода [getOrderState](/invest/services/orders/methods#getorderstate) в параметре **order_id** нужно передавать `order_id` из ответа метода [postOrder](/invest/services/orders/methods#postorder) — то есть биржевой идентификатор заявки.

Повторное использование одного и того же **order_id** в запросах метода [postOrder](/invest/services/orders/methods#postorder) приведет к ошибке, если уже существует успешно размещенная заявка с таким `order_id`.

## Отменить торговое поручение

Не все торговые поручения, которые выставляются на торговую площадку, могут и должны быть исполнены. 

Ситуация на рынке меняется динамично, поэтому торговому роботу нужна возможность отменять
выставленные заявки — для этого используйте метод [cancelOrder](/invest/services/orders/methods#cancelorder).

## Стрим исполнения поручений пользователя

T-Invest API предоставляет стрим с трансляцией исполнения сделок. В этот стрим попадают все
совершенные сделки по всем счетам пользователя. 

Чтобы сохранять стабильное подключение при отсутствии данных в stream-соединении, сервер периодически
отправляет ping-пакет. Клиенту не нужно на него реагировать.

## Изменить выставленную заявку

Чтобы изменять уже выставленные поручения, используйте метод [replaceOrder](/invest/services/orders/methods#replaceorder).
Через него можно отменить существующую выставленную заявку и выставить новую с измененными параметрами.

Чтобы использовать метод, понадобится идентификатор заявки на бирже, который вы получили при выставлении заявки через метод [postOrder](/invest/services/orders/methods#postorder).

Во время использования метода на этапах исполнения могут произойти разные события, и вернется ошибка. Например:

- Если поручение нельзя отменить, вернется ошибка с кодом `30059` и описанием причины в **message**.
- Если после отмены поручения нельзя выставить новое, вернется ошибка метода [postOrder](/invest/services/orders/methods#postorder) с соответствующим кодом и описанием. 

[Все коды и описания ошибок](/invest/intro/developer/error-codes/errors)

### Стрим совершенных сделок пользователя

В T-Invest API есть gRPC server-side [TradesStream](/invest/services/orders/methods#tradesstream) получения сделок с биржи.
Стрим предназначен для получения событий по поручениям пользователя по факту их исполнения.

TradesStream используется для быстрого получения информации об исполнении поручения и выполненных сделках в рамках поручения с отображением номера счета, на котором выполнилось поручение.

Для работы со стрим-соединениями есть [ограничения](/invest/intro/intro/limits).

### Получить торговые статусы инструментов и расписание торгов

[Торговые статусы инструментов и расписание торгов](/invest/intro/intro/faq_trading_status)

Также рекомендуем смотреть актуальную информацию по режимам и статусам торгов на сайтах [Московской биржи](https://www.moex.com/) и [СПБ биржи](https://spbexchange.ru/). 

### Выставить заявки по опционам 

Сейчас для работы с опционами в T-Invest API доступны только лимитные заявки. 
Рыночная заявка, тейк-профиты и стоп-заявки в разработке. 